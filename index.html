<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>丹丹漢堡 - 管理後台</title>
<style>
body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: #f8f8ff; margin:0; }
.header { background: #fff; padding: 1rem 2.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: center; }
.logo {font-size: 1.6rem; font-weight: bold; color: #e74c3c;}
.user-info {display: flex; align-items: center; gap: 1.3rem;}
.container {max-width: 1200px; margin: 2.5rem auto; padding: 0 2.5rem;}
.dashboard {display: flex; gap: 2.5rem; margin-bottom: 2.5rem;}
.card { background: white; border-radius: 14px; padding: 2.2rem; box-shadow: 0 4px 18px rgba(0,0,0,0.11); min-width:150px;flex:1;}
.card h3 {color: #2c3e50; margin-bottom: 1.1rem; font-size: 1.22rem;}
.stat-number {font-size: 2.1rem; font-weight: bold; color: #e74c3c;}
.btn {background: #e74c3c; color: white; border: none; padding: 0.85rem 1.6rem; border-radius: 6px; cursor: pointer;}
.orders-section { background: white; border-radius: 14px; padding: 2.1rem 1.2rem; box-shadow: 0 4px 18px rgba(0,0,0,0.10);}
.orders-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.3rem;}
.orders-table {width:100%;border-collapse:collapse;}
.orders-table th, .orders-table td {padding: 1.1rem 1.1rem; border-bottom: 1px solid #eee; text-align: left;}
.orders-table th {background: #fafafa; font-weight: bold; color: #2c3e50;}
.orders-table td, .orders-table th {white-space: nowrap;}
.order-items {font-size:1em; color:#333; margin:0; padding:0; list-style:none;}
.order-items li {margin-bottom:3px;}
..state-btn {
    margin: 0 2px 5px 0;
    padding: 3px 13px;
    font-size: 1em;
    border-radius: 5px;
    border: none;
    outline: none;
    cursor: pointer;
    width: auto;      /* 讓按鈕寬度隨內容縮短 */
    min-width: 0;
    max-width: 140px; /* 最寬不超過 140px（可再調整）*/
}

.state-preparing {background: #f39c12; color:#fff;}
.state-ready {background: #3498db; color:#fff;}
.state-completed {background: #2ecc71; color:#fff;}
.state-btn.active, .state-btn:focus {box-shadow: 0 2px 8px #e74c3c44; border:2.5px solid #2222;}
.delete-btn { background: #fff; color: #e74c3c; border: 1px solid #e74c3c; border-radius: 7px; font-size: 1em; padding: 5px 15px; margin-left: 10px; cursor: pointer;}
.delete-btn:hover {background:#ffe9e7;}
.toggle-btn {background:#fff;color:#e74c3c;border:1.5px solid #e74c3c;padding:0.95em 1.7em;margin-right:20px;font-size:1.07em;cursor:pointer;border-radius:7px;}
.toggle-btn.active {background:#e74c3c;color:#fff;}
.order-row-preparing {background: #fffbe7 !important;}
.order-row-ready {background: #fff !important;}
.order-row-completed {background: #fff !important;}
/* 狀態欄分行，置左排 */
.orders-table td.status-cell {
    display: flex;
    flex-direction: column;
    gap: 7px;
    align-items: flex-start;
}
@media (max-width: 1200px) {
    .container {max-width:98vw; padding:0 1vw;}
}
@media (max-width: 900px) {
    .container {padding: 8px;}
    .dashboard {flex-direction: column;}
    .orders-section{padding:0.6em;}
    .orders-table th, .orders-table td {font-size: 0.97em;padding:0.6em;}
    .orders-table{font-size:0.97em;}
    .orders-table th, .orders-table td {white-space:pre-line;word-break:break-all;}
    .orders-table td.status-cell {flex-direction: column; align-items: stretch;}
}
@media (max-width: 650px) {
    .container {padding:2px;}
    .orders-section{padding:0;}
    .orders-table th, .orders-table td {font-size:0.96em;}
    .orders-table{display:block;overflow-x:auto;}
}
</style>
</head>
<body>
<div class="header">
    <div class="logo">🍔 丹丹漢堡管理後台</div>
    <div class="user-info">
        <a href="menu.html" class="btn" style="background:#fff;color:#e74c3c;border:1px solid #e74c3c;">編輯菜單</a>
        <button class="btn" onclick="logout()">登出</button>
    </div>
</div>
<div class="container">
    <div style="margin-bottom: 18px;">
        <button class="toggle-btn" id="toggleBtn" onclick="toggleHistory()">歷史訂單</button>
        <span id="orderViewTitle" style="font-weight: bold; color: #e74c3c;">目前訂單</span>
    </div>
    <div class="dashboard">
        <div class="card">
            <h3>今日訂單</h3>
            <div class="stat-number" id="todayOrders">-</div>
        </div>
        <div class="card">
            <h3>累積訂單</h3>
            <div class="stat-number" id="totalOrders">-</div>
        </div>
        <div class="card">
            <h3>今日營收</h3>
            <div class="stat-number" id="todayRevenue">$-</div>
        </div>
    </div>
    <div class="orders-section">
        <div class="orders-header">
            <h3>訂單管理</h3>
            <button class="btn" onclick="refreshOrders()">重新整理</button>
        </div>
        <div style="overflow-x:auto;">
            <div id="ordersContainer"><div class="loading">載入訂單中...</div></div>
        </div>
    </div>
</div>
<script>
// === localStorage 安全存取
function getAllOrders() {
    try { let d=JSON.parse(localStorage.getItem('dandan_orders')||'[]'); return Array.isArray(d)?d:[] } catch(e){ return [] }
}
function setAllOrders(arr){
    localStorage.setItem('dandan_orders',JSON.stringify(arr));
}
function getHistoryOrders(){
    try { let d=JSON.parse(localStorage.getItem('dandan_orders_history')||'[]'); return Array.isArray(d)?d:[] } catch(e){ return [] }
}
function setHistoryOrders(arr){
    localStorage.setItem('dandan_orders_history',JSON.stringify(arr));
}
const STATE_MAP = {
    'preparing': { label:'製作中', css:'state-preparing' },
    'ready':     { label:'待取餐', css:'state-ready' },
    'completed': { label:'完成訂單', css:'state-completed' }
};
let viewHistory = false;
function toggleHistory(){
    viewHistory = !viewHistory;
    document.getElementById('orderViewTitle').textContent = viewHistory ? "歷史訂單" : "目前訂單";
    document.getElementById('toggleBtn').textContent = viewHistory ? "回到目前訂單" : "歷史訂單";
    document.getElementById('toggleBtn').className = viewHistory ? "toggle-btn active" : "toggle-btn";
    refreshOrders();
}
function isToday(dateStr){
    if(!dateStr) return false;
    const d = new Date(dateStr);
    const now = new Date();
    return d.getFullYear()===now.getFullYear()&&d.getMonth()===now.getMonth()&&d.getDate()===now.getDate();
}
function isThisMonth(dateStr){
    if(!dateStr) return false;
    const d = new Date(dateStr);
    const now = new Date();
    return d.getFullYear()===now.getFullYear()&&d.getMonth()===now.getMonth();
}
function renderStats(orders) {
    let todayCount=0, todayRevenue=0, monthCount=0;
    orders.forEach(order=>{
        if(order.status==='completed' && order.completed_at){
            if(isToday(order.completed_at)) {
                todayCount++;
                todayRevenue += calcOrderTotal(order);
            }
            if(isThisMonth(order.completed_at)){
                monthCount++;
            }
        }
    });
    document.getElementById('todayOrders').textContent = todayCount;
    document.getElementById('totalOrders').textContent = monthCount;
    document.getElementById('todayRevenue').textContent = "$" + todayRevenue;
}
function calcOrderTotal(order) {
    if(order.total) return order.total;
    let total = 0;
    if (order.items && Array.isArray(order.items)) {
        order.items.forEach(i=>{
            if(i.price) total += (i.price||0) * (i.quantity||1);
        });
    }
    return total;
}
function renderOrders(orders) {
    let html = `<table class="orders-table">
        <thead><tr>
            <th>編號</th>
            <th>姓名</th>
            <th>電話</th>
            <th>備註</th>
            <th>時間</th>
            <th>明細</th>
            <th>金額</th>
            <th>狀態</th>
            <th>操作</th>
        </tr></thead>
        <tbody>
    `;
    if(!orders.length) html += `<tr><td colspan="9" style="color:#bbb;text-align:center;padding:2em;">尚無訂單</td></tr>`;
    orders.slice().reverse().forEach((order,idx)=>{
        let state = order.status || 'preparing';
        let rowClass = viewHistory ? '' : 'order-row-' + state;
        html += `<tr class="${rowClass}">
            <td>${order.order_number||''}</td>
            <td>${order.customer_name||''}</td>
            <td>${order.customer_phone||''}</td>
            <td>${order.note||''}</td>
            <td>${order.completed_at?new Date(order.completed_at).toLocaleString('zh-TW'):
                order.created_at?new Date(order.created_at).toLocaleString('zh-TW'):""}</td>
            <td><ul class="order-items">${
                (order.items||[]).map(i=>{
                    let detail = i.name;
                    if(i.drink) detail += `（${i.drink}）`;
                    return `<li>${detail} × ${i.quantity||1}</li>`;
                }).join('')
            }</ul></td>
            <td style="font-weight:bold;color:#e74c3c;">$${calcOrderTotal(order)}</td>
            <td class="status-cell">
                ${viewHistory 
                    ? `<span class="state-btn state-completed active">${STATE_MAP.completed.label}</span>`
                    : renderStateBtns(order, idx, orders)}
            </td>
            <td>
                <button class="delete-btn" onclick="deleteOrder(${idx})">刪除</button>
            </td>
        </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('ordersContainer').innerHTML = html;
}
function renderStateBtns(order, idx, ordersArr){
    let now = order.status || 'preparing';
    return Object.entries(STATE_MAP).map(([k,v])=>{
        let cls = "state-btn "+v.css+(now===k?" active":"");
        return `<button class="${cls}" onclick="setOrderStatus(${idx},'${k}')">${v.label}</button>`;
    }).join('');
}
function setOrderStatus(idx, newStatus){
    let orders = getAllOrders();
    let index = orders.length-1-idx;
    let order = orders[index];
    if(order.status === newStatus) return;
    order.status = newStatus;
    if(newStatus==='completed') {
        order.completed_at = new Date().toISOString();
        let history = getHistoryOrders();
        if(!history.find(o=>o.order_number===order.order_number)){
            history.push({...order});
            setHistoryOrders(history);
        }
        orders.splice(index,1);
        setAllOrders(orders);
    } else {
        setAllOrders(orders);
    }
    refreshOrders();
}
function deleteOrder(idx){
    if(!confirm("確定要刪除此訂單？")) return;
    let orders = viewHistory ? getHistoryOrders() : getAllOrders();
    orders.splice(orders.length-1-idx, 1);
    if(viewHistory) setHistoryOrders(orders);
    else setAllOrders(orders);
    refreshOrders();
}
function refreshOrders() {
    let orders = viewHistory ? getHistoryOrders() : getAllOrders();
    renderStats(getHistoryOrders());
    renderOrders(orders);
}
function logout() { window.location.reload(); }
window.onload = function() { refreshOrders(); };
</script>
</body>
</html>
