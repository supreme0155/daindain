<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>丹丹漢堡 - 管理後台</title>
<style>
body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: #f8f8ff; margin:0; }
.header { background: #fff; padding: 1rem 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: center; }
.logo {font-size: 1.5rem; font-weight: bold; color: #e74c3c;}
.user-info {display: flex; align-items: center; gap: 1rem;}
.container {max-width: 600px; margin: 2rem auto; padding: 0 1rem;}
.dashboard {display: flex; gap: 2rem; margin-bottom: 2rem;}
.card { background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-width:120px;}
.card h3 {color: #2c3e50; margin-bottom: 1rem; font-size: 1.1rem;}
.stat-number {font-size: 2rem; font-weight: bold; color: #e74c3c;}
.btn {background: #e74c3c; color: white; border: none; padding: 0.7rem 1.2rem; border-radius: 5px; cursor: pointer;}
.orders-section { background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.09);}
.orders-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;}
.orders-table th, .orders-table td {padding: 0.7rem; border-bottom: 1px solid #eee; text-align: left;}
.orders-table th {background: #fafafa; font-weight: bold; color: #2c3e50;}
.order-items {font-size:0.97em; color:#333; margin:0; padding:0; list-style:none;}
.order-items li {margin-bottom:2px;}
@media (max-width: 900px) {
    .container {padding: 6px;}
    .dashboard {flex-direction: column;}
    .orders-table th, .orders-table td {font-size: 0.95em;}
}
</style>
</head>
<body>
<div class="header">
    <div class="logo">🍔 丹丹漢堡管理後台</div>
    <div class="user-info">
        <a href="menu.html" class="btn" style="background:#fff;color:#e74c3c;border:1px solid #e74c3c;">編輯菜單</a>
        <button class="btn" onclick="logout()">登出</button>
    </div>
</div>
<div class="container">
    <div class="dashboard">
        <div class="card">
            <h3>今日訂單</h3>
            <div class="stat-number" id="todayOrders">-</div>
        </div>
        <div class="card">
            <h3>累積訂單</h3>
            <div class="stat-number" id="totalOrders">-</div>
        </div>
        <div class="card">
            <h3>今日營收</h3>
            <div class="stat-number" id="todayRevenue">$-</div>
        </div>
    </div>
    <div class="orders-section">
        <div class="orders-header">
            <h3>訂單管理</h3>
            <button class="btn" onclick="refreshOrders()">重新整理</button>
        </div>
        <div id="ordersContainer"><div class="loading">載入訂單中...</div></div>
    </div>
</div>
<script>
// 🟢 防呆安全取得全部訂單
function getAllOrders() {
    try {
        let data = JSON.parse(localStorage.getItem('dandan_orders') || '[]');
        if (!Array.isArray(data)) return [];
        return data;
    } catch (e) {
        return [];
    }
}

// 🟢 取得最新菜單品項，用於金額核對
function getMenuData() {
    try { return JSON.parse(localStorage.getItem('dandan_menu') || 'null'); } catch (e) { return null; }
}
const defaultMenuData = [
  // 可依需要補預設品項，主要給 findMenuItem 用，或從 menu.html 複製
];

// 🟢 查找品項
function findMenuItemByName(name) {
    const menuData = getMenuData() || defaultMenuData;
    for(const cat of menuData){
        const item = (cat.items || []).find(it=>it.name===name);
        if(item) return item;
    }
    return null;
}
// 🟢 計算單筆訂單金額
function calcOrderTotal(order) {
    if(order.total) return order.total; // 若訂單有 total 欄位直接用
    let total = 0;
    if (order.items && Array.isArray(order.items)) {
        order.items.forEach(i=>{
            if(i.price) total += (i.price||0) * (i.quantity||1);
            else {
                // 若缺 price 嘗試用菜單找
                const item = findMenuItemByName(i.name);
                if(item) total += (item.price||0)*(i.quantity||1);
            }
        });
    }
    return total;
}

// 🟢 今日/累積/營收 統計
function renderStats(orders) {
    let today = new Date();
    let todayStr = today.toISOString().slice(0,10);
    let todayOrders = orders.filter(o => o.created_at && o.created_at.slice(0,10) === todayStr);
    let thisMonth = today.toISOString().slice(0,7);
    let monthOrders = orders.filter(o => o.created_at && o.created_at.slice(0,7) === thisMonth);
    let todayRevenue = todayOrders.reduce((sum,o)=>sum+calcOrderTotal(o),0);
    document.getElementById('todayOrders').textContent = todayOrders.length;
    document.getElementById('totalOrders').textContent = monthOrders.length;
    document.getElementById('todayRevenue').textContent = "$" + todayRevenue;
}

// 🟢 訂單列表
function renderOrders(orders) {
    let html = `<table class="orders-table" style="width:100%;border-collapse:collapse;">
        <thead><tr>
            <th>編號</th>
            <th>姓名</th>
            <th>電話</th>
            <th>備註</th>
            <th>時間</th>
            <th>明細</th>
            <th>金額</th>
        </tr></thead>
        <tbody>
    `;
    if(!orders.length) html += `<tr><td colspan="7" style="color:#bbb;text-align:center;padding:2em;">尚無訂單</td></tr>`;
    orders.slice().reverse().forEach((order,idx)=>{
        html += `<tr>
            <td>${order.order_number||''}</td>
            <td>${order.customer_name||''}</td>
            <td>${order.customer_phone||''}</td>
            <td>${order.note||''}</td>
            <td>${order.created_at ? new Date(order.created_at).toLocaleString('zh-TW') : ''}</td>
            <td><ul class="order-items">${
                (order.items||[]).map(i=>{
                    let detail = i.name;
                    if(i.drink) detail += `（${i.drink}）`;
                    return `<li>${detail} × ${i.quantity||1}</li>`;
                }).join('')
            }</ul></td>
            <td style="font-weight:bold;color:#e74c3c;">$${calcOrderTotal(order)}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('ordersContainer').innerHTML = html;
}

// 🟢 刷新
function refreshOrders() {
    let orders = getAllOrders();
    renderStats(orders);
    renderOrders(orders);
}
function logout() { window.location.reload(); }
window.onload = function() { refreshOrders(); };
</script>
</body>
</html>
