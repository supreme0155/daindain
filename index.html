<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ä¸¹ä¸¹æ¼¢å ¡ - ç®¡ç†å¾Œå°</title>
<style>
body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: #f8f8ff; margin:0; }
.header { background: #fff; padding: 1rem 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: center; }
.logo {font-size: 1.5rem; font-weight: bold; color: #e74c3c;}
.user-info {display: flex; align-items: center; gap: 1rem;}
.container {max-width: 600px; margin: 2rem auto; padding: 0 1rem;}
.dashboard {display: flex; gap: 2rem; margin-bottom: 2rem;}
.card { background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-width:120px;}
.card h3 {color: #2c3e50; margin-bottom: 1rem; font-size: 1.1rem;}
.stat-number {font-size: 2rem; font-weight: bold; color: #e74c3c;}
.btn {background: #e74c3c; color: white; border: none; padding: 0.7rem 1.2rem; border-radius: 5px; cursor: pointer;}
.orders-section { background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.09);}
.orders-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;}
.orders-table th, .orders-table td {padding: 0.7rem; border-bottom: 1px solid #eee; text-align: left;}
.orders-table th {background: #fafafa; font-weight: bold; color: #2c3e50;}
.order-items {font-size:0.97em; color:#333; margin:0; padding:0; list-style:none;}
.order-items li {margin-bottom:2px;}
@media (max-width: 900px) {
    .container {padding: 6px;}
    .dashboard {flex-direction: column;}
    .orders-table th, .orders-table td {font-size: 0.95em;}
}
</style>
</head>
<body>
<div class="header">
    <div class="logo">ğŸ” ä¸¹ä¸¹æ¼¢å ¡ç®¡ç†å¾Œå°</div>
    <div class="user-info">
        <a href="menu.html" class="btn" style="background:#fff;color:#e74c3c;border:1px solid #e74c3c;">ç·¨è¼¯èœå–®</a>
        <button class="btn" onclick="logout()">ç™»å‡º</button>
    </div>
</div>
<div class="container">
    <div class="dashboard">
        <div class="card">
            <h3>ä»Šæ—¥è¨‚å–®</h3>
            <div class="stat-number" id="todayOrders">-</div>
        </div>
        <div class="card">
            <h3>ç´¯ç©è¨‚å–®</h3>
            <div class="stat-number" id="totalOrders">-</div>
        </div>
        <div class="card">
            <h3>ä»Šæ—¥ç‡Ÿæ”¶</h3>
            <div class="stat-number" id="todayRevenue">$-</div>
        </div>
    </div>
    <div class="orders-section">
        <div class="orders-header">
            <h3>è¨‚å–®ç®¡ç†</h3>
            <button class="btn" onclick="refreshOrders()">é‡æ–°æ•´ç†</button>
        </div>
        <div id="ordersContainer"><div class="loading">è¼‰å…¥è¨‚å–®ä¸­...</div></div>
    </div>
</div>
<script>
// ğŸŸ¢ é˜²å‘†å®‰å…¨å–å¾—å…¨éƒ¨è¨‚å–®
function getAllOrders() {
    try {
        let data = JSON.parse(localStorage.getItem('dandan_orders') || '[]');
        if (!Array.isArray(data)) return [];
        return data;
    } catch (e) {
        return [];
    }
}

// ğŸŸ¢ å–å¾—æœ€æ–°èœå–®å“é …ï¼Œç”¨æ–¼é‡‘é¡æ ¸å°
function getMenuData() {
    try { return JSON.parse(localStorage.getItem('dandan_menu') || 'null'); } catch (e) { return null; }
}
const defaultMenuData = [
  // å¯ä¾éœ€è¦è£œé è¨­å“é …ï¼Œä¸»è¦çµ¦ findMenuItem ç”¨ï¼Œæˆ–å¾ menu.html è¤‡è£½
];

// ğŸŸ¢ æŸ¥æ‰¾å“é …
function findMenuItemByName(name) {
    const menuData = getMenuData() || defaultMenuData;
    for(const cat of menuData){
        const item = (cat.items || []).find(it=>it.name===name);
        if(item) return item;
    }
    return null;
}
// ğŸŸ¢ è¨ˆç®—å–®ç­†è¨‚å–®é‡‘é¡
function calcOrderTotal(order) {
    if(order.total) return order.total; // è‹¥è¨‚å–®æœ‰ total æ¬„ä½ç›´æ¥ç”¨
    let total = 0;
    if (order.items && Array.isArray(order.items)) {
        order.items.forEach(i=>{
            if(i.price) total += (i.price||0) * (i.quantity||1);
            else {
                // è‹¥ç¼º price å˜—è©¦ç”¨èœå–®æ‰¾
                const item = findMenuItemByName(i.name);
                if(item) total += (item.price||0)*(i.quantity||1);
            }
        });
    }
    return total;
}

// ğŸŸ¢ ä»Šæ—¥/ç´¯ç©/ç‡Ÿæ”¶ çµ±è¨ˆ
function renderStats(orders) {
    let today = new Date();
    let todayStr = today.toISOString().slice(0,10);
    let todayOrders = orders.filter(o => o.created_at && o.created_at.slice(0,10) === todayStr);
    let thisMonth = today.toISOString().slice(0,7);
    let monthOrders = orders.filter(o => o.created_at && o.created_at.slice(0,7) === thisMonth);
    let todayRevenue = todayOrders.reduce((sum,o)=>sum+calcOrderTotal(o),0);
    document.getElementById('todayOrders').textContent = todayOrders.length;
    document.getElementById('totalOrders').textContent = monthOrders.length;
    document.getElementById('todayRevenue').textContent = "$" + todayRevenue;
}

// ğŸŸ¢ è¨‚å–®åˆ—è¡¨
function renderOrders(orders) {
    let html = `<table class="orders-table" style="width:100%;border-collapse:collapse;">
        <thead><tr>
            <th>ç·¨è™Ÿ</th>
            <th>å§“å</th>
            <th>é›»è©±</th>
            <th>å‚™è¨»</th>
            <th>æ™‚é–“</th>
            <th>æ˜ç´°</th>
            <th>é‡‘é¡</th>
        </tr></thead>
        <tbody>
    `;
    if(!orders.length) html += `<tr><td colspan="7" style="color:#bbb;text-align:center;padding:2em;">å°šç„¡è¨‚å–®</td></tr>`;
    orders.slice().reverse().forEach((order,idx)=>{
        html += `<tr>
            <td>${order.order_number||''}</td>
            <td>${order.customer_name||''}</td>
            <td>${order.customer_phone||''}</td>
            <td>${order.note||''}</td>
            <td>${order.created_at ? new Date(order.created_at).toLocaleString('zh-TW') : ''}</td>
            <td><ul class="order-items">${
                (order.items||[]).map(i=>{
                    let detail = i.name;
                    if(i.drink) detail += `ï¼ˆ${i.drink}ï¼‰`;
                    return `<li>${detail} Ã— ${i.quantity||1}</li>`;
                }).join('')
            }</ul></td>
            <td style="font-weight:bold;color:#e74c3c;">$${calcOrderTotal(order)}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('ordersContainer').innerHTML = html;
}

// ğŸŸ¢ åˆ·æ–°
function refreshOrders() {
    let orders = getAllOrders();
    renderStats(orders);
    renderOrders(orders);
}
function logout() { window.location.reload(); }
window.onload = function() { refreshOrders(); };
</script>
</body>
</html>
