<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>丹丹漢堡 - 管理後台</title>
<style>
body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: #f8f8ff; margin:0; }
.header { background: #fff; padding: 1rem 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: center; }
.logo {font-size: 1.5rem; font-weight: bold; color: #e74c3c;}
.user-info {display: flex; align-items: center; gap: 1rem;}
.container {max-width: 650px; margin: 2rem auto; padding: 0 1rem;}
.dashboard {display: flex; gap: 2rem; margin-bottom: 2rem;}
.card { background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-width:120px;}
.card h3 {color: #2c3e50; margin-bottom: 1rem; font-size: 1.1rem;}
.stat-number {font-size: 2rem; font-weight: bold; color: #e74c3c;}
.btn {background: #e74c3c; color: white; border: none; padding: 0.7rem 1.2rem; border-radius: 5px; cursor: pointer;}
.orders-section { background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.09);}
.orders-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;}
.orders-table th, .orders-table td {padding: 0.7rem; border-bottom: 1px solid #eee; text-align: left;}
.orders-table th {background: #fafafa; font-weight: bold; color: #2c3e50;}
.order-items {font-size:0.97em; color:#333; margin:0; padding:0; list-style:none;}
.order-items li {margin-bottom:2px;}
.state-btn {margin: 0 2px; padding: 3px 10px; font-size:0.96em; border-radius:5px; border:none; outline:none; cursor:pointer;}
.state-preparing {background: #f39c12; color:#fff;}
.state-ready {background: #3498db; color:#fff;}
.state-completed {background: #2ecc71; color:#fff;}
.state-btn.active, .state-btn:focus {box-shadow: 0 2px 8px #e74c3c44; border:2.5px solid #2222;}
.delete-btn { background: #fff; color: #e74c3c; border: 1px solid #e74c3c; border-radius: 6px; font-size: 0.97em; padding: 4px 12px; margin-left: 10px; cursor: pointer;}
.delete-btn:hover {background:#ffe9e7;}
.toggle-btn {background:#fff;color:#e74c3c;border:1.3px solid #e74c3c;padding:0.7em 1.4em;margin-right:18px;font-size:1em;cursor:pointer;border-radius:6px;}
.toggle-btn.active {background:#e74c3c;color:#fff;}
@media (max-width: 900px) {
    .container {padding: 6px;}
    .dashboard {flex-direction: column;}
    .orders-table th, .orders-table td {font-size: 0.95em;}
}
</style>
</head>
<body>
<div class="header">
    <div class="logo">🍔 丹丹漢堡管理後台</div>
    <div class="user-info">
        <a href="menu.html" class="btn" style="background:#fff;color:#e74c3c;border:1px solid #e74c3c;">編輯菜單</a>
        <button class="btn" onclick="logout()">登出</button>
    </div>
</div>
<div class="container">
    <div style="margin-bottom: 18px;">
        <button class="toggle-btn" id="toggleBtn" onclick="toggleHistory()">歷史訂單</button>
        <span id="orderViewTitle" style="font-weight: bold; color: #e74c3c;">目前訂單</span>
    </div>
    <div class="dashboard">
        <div class="card">
            <h3>今日訂單</h3>
            <div class="stat-number" id="todayOrders">-</div>
        </div>
        <div class="card">
            <h3>累積訂單</h3>
            <div class="stat-number" id="totalOrders">-</div>
        </div>
        <div class="card">
            <h3>今日營收</h3>
            <div class="stat-number" id="todayRevenue">$-</div>
        </div>
    </div>
    <div class="orders-section">
        <div class="orders-header">
            <h3>訂單管理</h3>
            <button class="btn" onclick="refreshOrders()">重新整理</button>
        </div>
        <div id="ordersContainer"><div class="loading">載入訂單中...</div></div>
    </div>
</div>
<script>
// === localStorage 安全存取
function getAllOrders() {
    try { let d=JSON.parse(localStorage.getItem('dandan_orders')||'[]'); return Array.isArray(d)?d:[] } catch(e){ return [] }
}
function setAllOrders(arr){
    localStorage.setItem('dandan_orders',JSON.stringify(arr));
}
function getHistoryOrders(){
    try { let d=JSON.parse(localStorage.getItem('dandan_orders_history')||'[]'); return Array.isArray(d)?d:[] } catch(e){ return [] }
}
function setHistoryOrders(arr){
    localStorage.setItem('dandan_orders_history',JSON.stringify(arr));
}

// === 狀態切換
const STATE_MAP = {
    'preparing': { label:'製作中', css:'state-preparing' },
    'ready':     { label:'待取餐', css:'state-ready' },
    'completed': { label:'完成訂單', css:'state-completed' }
};
let viewHistory = false;
function toggleHistory(){
    viewHistory = !viewHistory;
    document.getElementById('orderViewTitle').textContent = viewHistory ? "歷史訂單" : "目前訂單";
    document.getElementById('toggleBtn').textContent = viewHistory ? "回到目前訂單" : "歷史訂單";
    document.getElementById('toggleBtn').className = viewHistory ? "toggle-btn active" : "toggle-btn";
    refreshOrders();
}

// === 統計只計算「已完成」訂單
function isToday(dateStr){
    if(!dateStr) return false;
    const d = new Date(dateStr);
    const now = new Date();
    return d.getFullYear()===now.getFullYear()&&d.getMonth()===now.getMonth()&&d.getDate()===now.getDate();
}
function isThisMonth(dateStr){
    if(!dateStr) return false;
    const d = new Date(dateStr);
    const now = new Date();
    return d.getFullYear()===now.getFullYear()&&d.getMonth()===now.getMonth();
}
function renderStats(orders) {
    let todayCount=0, todayRevenue=0, monthCount=0;
    orders.forEach(order=>{
        if(order.status==='completed' && order.completed_at){
            if(isToday(order.completed_at)) {
                todayCount++;
                todayRevenue += calcOrderTotal(order);
            }
            if(isThisMonth(order.completed_at)){
                monthCount++;
            }
        }
    });
    document.getElementById('todayOrders').textContent = todayCount;
    document.getElementById('totalOrders').textContent = monthCount;
    document.getElementById('todayRevenue').textContent = "$" + todayRevenue;
}

// === 計算金額
function calcOrderTotal(order) {
    if(order.total) return order.total;
    let total = 0;
    if (order.items && Array.isArray(order.items)) {
        order.items.forEach(i=>{
            if(i.price) total += (i.price||0) * (i.quantity||1);
        });
    }
    return total;
}

// === 訂單渲染
function renderOrders(orders) {
    let html = `<table class="orders-table" style="width:100%;border-collapse:collapse;">
        <thead><tr>
            <th>編號</th>
            <th>姓名</th>
            <th>電話</th>
            <th>備註</th>
            <th>時間</th>
            <th>明細</th>
            <th>金額</th>
            <th>狀態</th>
            <th>操作</th>
        </tr></thead>
        <tbody>
    `;
    if(!orders.length) html += `<tr><td colspan="9" style="color:#bbb;text-align:center;padding:2em;">尚無訂單</td></tr>`;
    orders.slice().reverse().forEach((order,idx)=>{
        html += `<tr>
            <td>${order.order_number||''}</td>
            <td>${order.customer_name||''}</td>
            <td>${order.customer_phone||''}</td>
            <td>${order.note||''}</td>
            <td>${order.completed_at?new Date(order.completed_at).toLocaleString('zh-TW'):
                order.created_at?new Date(order.created_at).toLocaleString('zh-TW'):""}</td>
            <td><ul class="order-items">${
                (order.items||[]).map(i=>{
                    let detail = i.name;
                    if(i.drink) detail += `（${i.drink}）`;
                    return `<li>${detail} × ${i.quantity||1}</li>`;
                }).join('')
            }</ul></td>
            <td style="font-weight:bold;color:#e74c3c;">$${calcOrderTotal(order)}</td>
            <td>
                ${renderStateBtns(order, idx, orders)}
            </td>
            <td>
                <button class="delete-btn" onclick="deleteOrder(${idx})">刪除</button>
            </td>
        </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('ordersContainer').innerHTML = html;
}

// === 狀態切換按鈕
function renderStateBtns(order, idx, ordersArr){
    if(viewHistory) return `<span class="state-btn state-completed active">${STATE_MAP.completed.label}</span>`;
    let now = order.status || 'preparing';
    return Object.entries(STATE_MAP).map(([k,v])=>{
        let cls = "state-btn "+v.css+(now===k?" active":"");
        return `<button class="${cls}" onclick="setOrderStatus(${idx},'${k}')">${v.label}</button>`;
    }).join('');
}

// === 狀態切換與完成自動存入歷史
function setOrderStatus(idx, newStatus){
    let orders = getAllOrders();
    let order = orders[orders.length-1-idx];
    if(order.status === newStatus) return;
    order.status = newStatus;
    if(newStatus==='completed') order.completed_at = new Date().toISOString();
    setAllOrders(orders);
    if(newStatus==='completed'){
        let history = getHistoryOrders();
        // 防重複
        if(!history.find(o=>o.order_number===order.order_number)){
            history.push({...order});
            setHistoryOrders(history);
        }
    }
    refreshOrders();
}

// === 刪除訂單
function deleteOrder(idx){
    if(!confirm("確定要刪除此訂單？")) return;
    let orders = viewHistory ? getHistoryOrders() : getAllOrders();
    orders.splice(orders.length-1-idx, 1);
    if(viewHistory) setHistoryOrders(orders);
    else setAllOrders(orders);
    refreshOrders();
}

// === 渲染主流程
function refreshOrders() {
    let orders = viewHistory ? getHistoryOrders() : getAllOrders();
    renderStats(getHistoryOrders()); // 統計只計算已完成訂單
    renderOrders(orders);
}
function logout() { window.location.reload(); }
window.onload = function() { refreshOrders(); };
</script>
</body>
</html>
