<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>丹丹漢堡 - 線上點餐</title>
<meta name="color-scheme" content="light dark">
<style>
body{font-family:'Microsoft JhengHei',Arial,sans-serif;background:#fff8f4;}
.header{background:#e74c3c;color:#fff;text-align:center;padding:1.3rem 0 0.8rem;}
.header h1{margin:0 0 4px 0;font-size:2rem;font-weight:bold;}
.header p{margin:0;font-size:1rem;}
.container{max-width:860px;margin:20px auto 0 auto;padding:12px;background:#fff;border-radius:18px;box-shadow:0 4px 16px #e74c3c19;}
.cart-summary{position:fixed;bottom:0;left:0;right:0;background:#fffbe7;border-top:2px solid #ffd580;display:flex;align-items:center;justify-content:space-between;padding:14px 6vw;box-shadow:0 -3px 18px #e67e2280;z-index:99;font-size:1.12rem;}
.cat-note{background:#fff4c2;border-radius:8px;color:#b45b02;font-size:1em;padding:8px 10px 7px 14px;margin:8px 0 10px 0;}
.category{margin-bottom:20px;border-radius:14px;background:#f9f9f9;box-shadow:0 2px 7px #0001;overflow:hidden;}
.category-header{background:#e74c3c;color:#fff;font-size:1.13rem;padding:1rem 1.2rem;font-weight:bold;cursor:pointer;}
.category-header.collapsed{border-radius:14px;}
.category-items{padding:0.4rem 0.9rem 0.7rem 1.2rem;}
.menu-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0 9px 0;border-bottom:1px solid #eee;}
.menu-item:last-child{border-bottom:none;}
.item-info{font-size:1.08rem;font-weight:500;}
.item-controls{display:flex;align-items:center;gap:12px;}
.item-price{font-size:1.1rem;color:#e74c3c;font-weight:bold;}
.quantity-control{display:flex;align-items:center;gap:0.3rem;background:#eee;border-radius:7px;padding:2px 7px;}
.quantity-btn{border:none;background:#ffd700;color:#e74c3c;font-size:1.1rem;width:30px;height:32px;border-radius:7px;font-weight:bold;cursor:pointer;}
.quantity-btn:disabled{opacity:0.5;cursor:not-allowed;}
.quantity{display:inline-block;min-width:1.5em;text-align:center;font-weight:bold;}
/* Modal 樣式 */
.modal{display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:1000;}
.modal-content{background:#fff;padding:2rem 1.7rem 1.4rem 1.7rem;border-radius:14px;max-width:390px;width:97vw;margin:10vh auto;box-shadow:0 8px 32px #0002;position:relative;}
.close{position:absolute;top:0.7rem;right:1.1rem;font-size:1.6rem;color:#e74c3c;cursor:pointer;font-weight:bold;}
@media(max-width:700px){.container{padding:2px;margin:0;}}
</style>
</head>
<body>
<div class="header">
  <h1>🍔 丹丹漢堡</h1>
  <p>線上點餐系統</p>
</div>
<div class="container" id="menuSection">
  <div id="menuContainer"><div class="loading">載入菜單中...</div></div>
</div>
<div class="cart-summary" id="cartSummary">
  <div class="cart-info">
    <div class="cart-count">已選 <span id="cartCount">0</span> 項</div>
    <div class="cart-total">總計 $<span id="cartTotal">0</span></div>
  </div>
  <button class="checkout-btn" id="checkoutBtn" onclick="showCheckout()" disabled>前往結帳</button>
</div>

<!-- 🟢 Modal：結帳 -->
<div class="modal" id="checkoutModal">
  <div class="modal-content">
    <span class="close" onclick="closeCheckout()">&times;</span>
    <h2 style="color:#e74c3c;margin-bottom:0.7em;">結帳資料</h2>
    <form id="orderForm">
      <div style="margin-bottom:0.9em;">
        <label>姓名*<br>
        <input type="text" id="customerName" required style="width:100%;padding:8px;border-radius:5px;"></label>
      </div>
      <div style="margin-bottom:0.9em;">
        <label>電話*<br>
        <input type="tel" id="customerPhone" required style="width:100%;padding:8px;border-radius:5px;"></label>
      </div>
      <div style="margin-bottom:0.8em;">
        <label>備註<br>
        <input type="text" id="customerNote" style="width:100%;padding:8px;border-radius:5px;"></label>
      </div>
      <div style="font-size:1.07em;margin-bottom:1.1em;">
        <strong>訂單明細：</strong><br>
        <div id="orderSummary"></div>
        <div style="margin-top:0.7em;font-weight:bold;">總計：$<span id="orderSumTotal"></span></div>
      </div>
      <div id="orderError" style="color:#e74c3c;margin-bottom:0.5em;display:none;"></div>
      <button type="submit" class="checkout-btn" style="width:100%;">送出訂單</button>
    </form>
  </div>
</div>

<!-- 🟢 Modal：送出完成 -->
<div class="modal" id="orderSuccessModal">
  <div class="modal-content" style="text-align:center;">
    <h2 style="color:#2ecc71;">✅ 訂單已送出</h2>
    <div style="margin:1.5em 0 1em 0;">感謝您的訂購！<br>請至櫃檯等候取餐。</div>
    <button class="checkout-btn" style="width:70%;" onclick="closeSuccess()">確定</button>
  </div>
</div>

<script>
// === 🟢 預設菜單：可用 menu.html 自訂更新 ===
const defaultMenuData = [
  {
    category: "精選定食餐 (附29元飲料)",
    note: "一份套餐限加購$26地瓜薯條 或 $39義式紅醬波浪薯；漢堡可+$10加吉司 (起司)；早上10點前可加蛋",
    items: [
      { name: "招牌漢堡排+腿皮炸雞+腿皮飯", price: 104, drink: "" },
      { name: "香酥雞腿排+腿皮炸雞+腿皮飯", price: 104, drink: "" },
      { name: "漢堡排豬肉堡+腿皮炸雞+腿皮飯", price: 97, drink: "" },
      { name: "招牌雞塊+腿皮炸雞+腿皮飯", price: 104, drink: "" },
      { name: "鮮嫩雞腿堡+玉米濃湯", price: 99, drink: "" },
      { name: "鮮嫩雞米花+腿皮飯", price: 97, drink: "" },
      { name: "迷迭香雞+腿皮炸雞", price: 107, drink: "" },
      { name: "招牌漢堡排+腿皮飯+玉米濃湯", price: 114, drink: "" },
      { name: "香酥雞腿排+腿皮飯+玉米濃湯", price: 114, drink: "" },
      { name: "漢堡排豬肉堡+腿皮飯+玉米濃湯", price: 108, drink: "" },
      { name: "鮮嫩雞腿堡+腿皮飯+玉米濃湯", price: 107, drink: "" },
      { name: "五穀雞肉粥+金色薯條餐", price: 94, drink: "" },
      { name: "赤肉羹麵線+雞可樂餅", price: 82, drink: "" },
      { name: "香酥吉列豬排堡+杏鮑菇炸棒", price: 99, drink: "" }
    ]
  },
  {
    category: "早安特惠餐 (附29元飲料)",
    note: "一份套餐限加購$26地瓜薯條 或 $39義式紅醬波浪薯；漢堡可+$10加吉司 (起司)；早上10點前可加蛋",
    items: [
      { name: "漢堡蛋+黃金薯條", price: 54, drink: "" },
      { name: "腿皮炸雞堡+薯餅", price: 54, drink: "" },
      { name: "鮮嫩雞米花+腿皮飯", price: 50, drink: "" },
      { name: "招牌雞塊+腿皮飯", price: 50, drink: "" },
      { name: "五穀雞肉粥", price: 43, drink: "" },
      { name: "雞蛋吐司+黃金雞米花", price: 43, drink: "" },
      { name: "奶酪可麗餅", price: 28, drink: "" }
    ]
  },
  {
    category: "美味丹點",
    items: [
      { name: "排骨酥肉燥麵", price: 68 },
      { name: "赤肉羹麵線煲", price: 45 },
      { name: "香菇雞腿飯", price: 68 },
      { name: "雞蛋飯", price: 41 },
      { name: "玉米濃湯", price: 27 },
      { name: "無骨雞塊(9入)", price: 78 },
      { name: "黃金雞米花", price: 47 },
      { name: "腿皮炸雞", price: 47 },
      { name: "豬肉可樂餅", price: 41 },
      { name: "雞可樂餅", price: 41 },
      { name: "雞米花", price: 37 },
      { name: "鮮嫩雞腿堡", price: 66 },
      { name: "香酥吉列豬排堡", price: 66 },
      { name: "雞蛋吐司", price: 37 },
      { name: "黃金薯條", price: 41 },
      { name: "紅藜波浪薯", price: 36 },
      { name: "薯餅", price: 23 },
      { name: "杏鮑菇炸棒", price: 41 }
    ]
  },
  // 飲品（可根據你的最新價格表補齊）
  {
    category: "飲品",
    items: [
      { name: "可樂(中)", price: 29 },
      { name: "可樂(大)", price: 34 },
      { name: "汽水(中)", price: 29 },
      { name: "汽水(大)", price: 34 },
      { name: "錫蘭紅茶(中)", price: 29 },
      { name: "錫蘭紅茶(大)", price: 34 },
      { name: "蘋果汁(中)", price: 29 },
      { name: "蘋果汁(大)", price: 34 },
      { name: "台灣烏龍(無糖)(中)", price: 29 },
      { name: "台灣烏龍(無糖)(大)", price: 34 },
      { name: "紅茶牛奶(中)", price: 29 },
      { name: "紅茶牛奶(大)", price: 34 },
      { name: "熱桂花烏龍", price: 29 },
      { name: "熱美式(新品)", price: 29 }
    ]
  }
];

// === 🟢 菜單載入 ===
let menuData;
try {
    menuData = JSON.parse(localStorage.getItem('dandan_menu'));
    if(!menuData || !Array.isArray(menuData) || !menuData[0]?.category) throw "no menu";
} catch(e) {
    menuData = defaultMenuData;
}
let cart = {};
let collapsedCat = {};
window.addEventListener('load', () => {
  displayMenu();
  updateCartDisplay();
  adjustContainerPadding();
});
window.addEventListener('resize', adjustContainerPadding);
// === 🟢 自動補底部空間 ===
function adjustContainerPadding() {
  const cart = document.getElementById('cartSummary');
  const container = document.getElementById('menuSection');
  if(cart && container) {
    cart.style.visibility = "hidden"; cart.style.display = "block";
    setTimeout(function() {
      const h = cart.offsetHeight || 90;
      container.style.paddingBottom = (h + 20) + "px";
      cart.style.visibility = ""; cart.style.display = "";
    }, 40);
  }
}
function displayMenu() {
  const container = document.getElementById('menuContainer');
  if (!menuData.length) {
    container.innerHTML = '<div class="error">暫無菜單資料</div>';
    return;
  }
  let html = menuData.map((category, ci) => {
    const items = (category.items || []);
    const colKey = category.category;
    const collapsed = collapsedCat[colKey] === true;
    return `
      <div class="category">
        <div class="category-header${collapsed ? ' collapsed' : ''}" onclick="toggleCat('${colKey}')">
          ${category.category} <span style="font-size:0.98em;float:right;">${collapsed ? '＋' : '－'}</span>
        </div>
        ${category.note ? `<div class="cat-note">${category.note}</div>` : ''}
        <div class="category-items" style="display:${collapsed ? 'none' : 'block'};">
          ${items.map((item, iidx) => `
            <div class="menu-item">
              <div class="item-info">${item.name}</div>
              <div class="item-controls">
                <div class="item-price">$${item.price}</div>
                ${(typeof item.drink !== "undefined") ? renderDrinkSelect(ci,iidx,item.drink) : ""}
                <div class="quantity-control">
                  <button class="quantity-btn" onclick="updateQuantity('${ci}-${iidx}', -1)" ${!cart[ci+'-'+iidx] ? 'disabled' : ''}>-</button>
                  <span class="quantity">${cart[ci+'-'+iidx] || 0}</span>
                  <button class="quantity-btn" onclick="updateQuantity('${ci}-${iidx}', 1)">+</button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }).join('');
  container.innerHTML = html;
}
function renderDrinkSelect(ci,iidx,selected){
  const drinkOptions = [
    "可樂(中)", "可樂(大)", "汽水(中)", "汽水(大)", "錫蘭紅茶(中)", "錫蘭紅茶(大)",
    "蘋果汁(中)", "蘋果汁(大)", "台灣烏龍(無糖)(中)", "台灣烏龍(無糖)(大)",
    "紅茶牛奶(中)", "紅茶牛奶(大)", "熱桂花烏龍", "熱美式(新品)"
  ];
  let opts = drinkOptions.map(d => `<option value="${d}"${selected===d?' selected':''}>${d}</option>`).join('');
  return `<select onchange="selectDrink('${ci}-${iidx}',this.value)">
    <option value="">--飲料--</option>${opts}
  </select>`;
}
function selectDrink(key, val){
  const [ci,iidx] = key.split('-').map(x=>parseInt(x,10));
  menuData[ci].items[iidx].drink = val;
}
function toggleCat(key) {
  collapsedCat[key] = !collapsedCat[key];
  displayMenu();
}
function updateQuantity(key, change) {
  if (!cart[key]) cart[key] = 0;
  cart[key] += change;
  if (cart[key] <= 0) delete cart[key];
  updateCartDisplay();
  displayMenu();
}
function updateCartDisplay() {
  let totalItems = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
  let totalPrice = 0;
  Object.entries(cart).forEach(([key, qty]) => {
    const [ci,iidx] = key.split('-').map(x=>parseInt(x,10));
    const item = menuData[ci]?.items?.[iidx];
    if(item) totalPrice += (item.price || 0) * qty;
  });
  document.getElementById('cartCount').textContent = totalItems;
  document.getElementById('cartTotal').textContent = totalPrice;
  document.getElementById('checkoutBtn').disabled = totalItems === 0;
}

// === 🟢 結帳流程 ===
function showCheckout() {
    // 顯示 modal
    document.getElementById('checkoutModal').style.display = 'block';
    // 訂單明細
    let summaryArr = Object.entries(cart).map(([key, qty]) => {
        const [ci,iidx] = key.split('-').map(x=>parseInt(x,10));
        const item = menuData[ci]?.items?.[iidx];
        if(!item) return '';
        let str = item.name;
        if(typeof item.drink !== "undefined" && item.drink) str += `（${item.drink}）`;
        return str + ` ×${qty} = $${item.price*qty}`;
    });
    document.getElementById('orderSummary').innerHTML = summaryArr.map(s=>`<div>${s}</div>`).join('');
    // 總價
    let total = Object.entries(cart).reduce((sum, [key, qty]) => {
        const [ci,iidx] = key.split('-').map(x=>parseInt(x,10));
        const item = menuData[ci]?.items?.[iidx];
        return sum + (item ? item.price*qty : 0);
    }, 0);
    document.getElementById('orderSumTotal').textContent = total;
    document.getElementById('orderError').style.display = "none";
}
function closeCheckout() {
    document.getElementById('checkoutModal').style.display = 'none';
}
document.getElementById('orderForm').addEventListener('submit', function(e){
    e.preventDefault();
    // 檢查
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    const note = document.getElementById('customerNote').value.trim();
    if(!name || !phone){
        document.getElementById('orderError').textContent = "請輸入姓名和電話";
        document.getElementById('orderError').style.display = "";
        return;
    }
    // 組訂單資料
    let orderItems = Object.entries(cart).map(([key, qty]) => {
        const [ci,iidx] = key.split('-').map(x=>parseInt(x,10));
        const item = menuData[ci]?.items?.[iidx];
        if(!item) return null;
        return {
            name: item.name,
            price: item.price,
            drink: (typeof item.drink !== "undefined") ? item.drink : undefined,
            quantity: qty
        }
    }).filter(Boolean);
    let total = orderItems.reduce((sum, i) => sum + i.price*i.quantity, 0);
    // 寫進 localStorage
    let allOrders = [];
    try { allOrders = JSON.parse(localStorage.getItem('dandan_orders')||'[]'); } catch(e){}
    allOrders.push({
        order_number: 'D' + Date.now(),
        customer_name: name,
        customer_phone: phone,
        note: note,
        items: orderItems,
        created_at: new Date().toISOString(),
        total
    });
    localStorage.setItem('dandan_orders', JSON.stringify(allOrders));
    // 清空購物車
    cart = {};
    updateCartDisplay();
    closeCheckout();
    document.getElementById('orderSuccessModal').style.display = 'block';
});
function closeSuccess(){
    document.getElementById('orderSuccessModal').style.display = 'none';
    // 可重新整理或跳轉
}
</script>
</body>
</html>
