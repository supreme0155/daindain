<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸¹ä¸¹æ¼¢å ¡ - ç·šä¸Šé»é¤</title>
<meta name="color-scheme" content="light dark">
<style>
body{font-family:'Microsoft JhengHei',Arial,sans-serif;background:#fff8f4;}
.header{background:#e74c3c;color:#fff;text-align:center;padding:1.3rem 0 0.8rem;}
.header h1{margin:0 0 4px 0;font-size:2rem;font-weight:bold;}
.header p{margin:0;font-size:1rem;}
.container{max-width:860px;margin:20px auto 0 auto;padding:12px;background:#fff;border-radius:18px;box-shadow:0 4px 16px #e74c3c19;}
.cart-summary{position:fixed;bottom:0;left:0;right:0;background:#fffbe7;border-top:2px solid #ffd580;display:flex;align-items:center;justify-content:space-between;padding:14px 6vw;box-shadow:0 -3px 18px #e67e2280;z-index:99;font-size:1.12rem;}
.cat-note{background:#fff4c2;border-radius:8px;color:#b45b02;font-size:1em;padding:8px 10px 7px 14px;margin:8px 0 10px 0;}
.category{margin-bottom:20px;border-radius:14px;background:#f9f9f9;box-shadow:0 2px 7px #0001;overflow:hidden;}
.category-header{background:#e74c3c;color:#fff;font-size:1.13rem;padding:1rem 1.2rem;font-weight:bold;cursor:pointer;}
.category-header.collapsed{border-radius:14px;}
.category-items{padding:0.4rem 0.9rem 0.7rem 1.2rem;}
.menu-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0 9px 0;border-bottom:1px solid #eee;}
.menu-item:last-child{border-bottom:none;}
.item-info{font-size:1.08rem;font-weight:500;}
.item-controls{display:flex;align-items:center;gap:12px;}
.item-price{font-size:1.1rem;color:#e74c3c;font-weight:bold;}
.quantity-control{display:flex;align-items:center;gap:0.3rem;background:#eee;border-radius:7px;padding:2px 7px;}
.quantity-btn{border:none;background:#ffd700;color:#e74c3c;font-size:1.1rem;width:30px;height:32px;border-radius:7px;font-weight:bold;cursor:pointer;}
.quantity-btn:disabled{opacity:0.5;cursor:not-allowed;}
.quantity{display:inline-block;min-width:1.5em;text-align:center;font-weight:bold;}
/* Modal æ¨£å¼ */
.modal{display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:1000;}
.modal-content {
  background:#fff;
  padding:2rem 1.7rem 1.4rem 1.7rem;
  border-radius:14px;
  max-width:390px;
  width:97vw;
  margin:10vh auto;
  box-shadow:0 8px 32px #0002;
  position:relative;
}
@media (max-width: 540px) {
  .modal-content {
    padding: 1.1rem 0.4rem 1.1rem 0.4rem;
    max-width: 98vw;
    min-width: 0;
    border-radius:10px;
  }
}
@media (max-width: 360px) {
  .modal-content {
    padding: 0.2rem 0.1rem 0.8rem 0.1rem;
    max-width: 100vw;
    font-size: 0.98em;
  }
}
.close{position:absolute;top:0.7rem;right:1.1rem;font-size:1.6rem;color:#e74c3c;cursor:pointer;font-weight:bold;}
@media(max-width:700px){.container{padding:2px;margin:0;}}
</style>
</head>
<body>
<div class="header">
  <h1>ğŸ” ä¸¹ä¸¹æ¼¢å ¡</h1>
  <p>ç·šä¸Šé»é¤ç³»çµ±</p>
</div>
<div class="container" id="menuSection">
  <div id="menuContainer"><div class="loading">è¼‰å…¥èœå–®ä¸­...</div></div>
</div>
<div class="cart-summary" id="cartSummary">
  <div class="cart-info">
    <div class="cart-count">å·²é¸ <span id="cartCount">0</span> é …</div>
    <div class="cart-total">ç¸½è¨ˆ $<span id="cartTotal">0</span></div>
  </div>
  <button class="checkout-btn" id="checkoutBtn" onclick="showCheckout()" disabled>å‰å¾€çµå¸³</button>
</div>

<!-- ğŸŸ¢ Modalï¼šçµå¸³ -->
<div class="modal" id="checkoutModal">
  <div class="modal-content">
    <span class="close" onclick="closeCheckout()">&times;</span>
    <h2 style="color:#e74c3c;margin-bottom:0.7em;">çµå¸³è³‡æ–™</h2>
    <form id="orderForm">
      <div style="margin-bottom:0.9em;">
        <label>å§“å*<br>
        <input type="text" id="customerName" required style="width:100%;padding:8px;border-radius:5px;"></label>
      </div>
      <div style="margin-bottom:0.9em;">
        <label>é›»è©±*<br>
        <input type="tel" id="customerPhone" required style="width:100%;padding:8px;border-radius:5px;"></label>
      </div>
      <div style="margin-bottom:0.8em;">
        <label>å‚™è¨»<br>
        <input type="text" id="customerNote" style="width:100%;padding:8px;border-radius:5px;"></label>
      </div>
      <div style="font-size:1.07em;margin-bottom:1.1em;">
        <strong>è¨‚å–®æ˜ç´°ï¼š</strong><br>
        <div id="orderSummary"></div>
        <div style="margin-top:0.7em;font-weight:bold;">ç¸½è¨ˆï¼š$<span id="orderSumTotal"></span></div>
      </div>
      <div id="orderError" style="color:#e74c3c;margin-bottom:0.5em;display:none;"></div>
      <button type="submit" class="checkout-btn" style="width:100%;">é€å‡ºè¨‚å–®</button>
    </form>
  </div>
</div>

<!-- ğŸŸ¢ Modalï¼šé€å‡ºå®Œæˆ -->
<div class="modal" id="orderSuccessModal">
  <div class="modal-content" style="text-align:center;">
    <h2 style="color:#2ecc71;">âœ… è¨‚å–®å·²é€å‡º</h2>
    <div style="margin:1.5em 0 1em 0;">æ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼<br>è«‹è‡³æ«ƒæª¯ç­‰å€™å–é¤ã€‚</div>
    <button class="checkout-btn" style="width:70%;" onclick="closeSuccess()">ç¢ºå®š</button>
  </div>
</div>

<script>
// === å¼·åˆ¶åªé€£æ¥ menu.html ç·¨è¼¯çš„èœå–® ===
let menuData = [];
try {
  menuData = JSON.parse(localStorage.getItem('dandan_menu')) || [];
  if(!menuData || !Array.isArray(menuData) || !menuData[0]?.category) throw "no menu";
} catch(e) {
  menuData = [];
}
let cart = {};
let collapsedCat = {};

window.addEventListener('load', () => {
  displayMenu();
  updateCartDisplay();
  adjustContainerPadding();
});
window.addEventListener('resize', adjustContainerPadding);

function adjustContainerPadding() {
  const cart = document.getElementById('cartSummary');
  const container = document.getElementById('menuSection');
  if(cart && container) {
    cart.style.visibility = "hidden"; cart.style.display = "block";
    setTimeout(function() {
      const h = cart.offsetHeight || 90;
      container.style.paddingBottom = (h + 20) + "px";
      cart.style.visibility = ""; cart.style.display = "";
    }, 40);
  }
}
function displayMenu() {
  const container = document.getElementById('menuContainer');
  if (!menuData.length) {
    container.innerHTML = '<div class="error" style="padding:2em;text-align:center;color:#e74c3c;font-size:1.25em;">æš«ç„¡èœå–®è³‡æ–™<br>è«‹ç®¡ç†å“¡è‡³ menu.html å»ºç«‹èœå–®</div>';
    return;
  }
  let html = menuData.map((category, ci) => {
    const items = (category.items || []);
    const colKey = category.category;
    const collapsed = collapsedCat[colKey] === true;
    return `
      <div class="category">
        <div class="category-header${collapsed ? ' collapsed' : ''}" onclick="toggleCat('${colKey}')">
          ${category.category} <span style="font-size:0.98em;float:right;">${collapsed ? 'ï¼‹' : 'ï¼'}</span>
        </div>
        ${category.note ? `<div class="cat-note">${category.note}</div>` : ''}
        <div class="category-items" style="display:${collapsed ? 'none' : 'block'};">
          ${items.map((item, iidx) => `
            <div class="menu-item">
              <div class="item-info">${item.name}</div>
              <div class="item-controls">
                <div class="item-price">$${item.price}</div>
                ${(typeof item.drink !== "undefined") ? renderDrinkSelect(ci,iidx,item.drink) : ""}
                <div class="quantity-control">
                  <button class="quantity-btn" onclick="updateQuantity('${ci}-${iidx}', -1)" ${!cart[ci+'-'+iidx] ? 'disabled' : ''}>-</button>
                  <span class="quantity">${cart[ci+'-'+iidx] || 0}</span>
                  <button class="quantity-btn" onclick="updateQuantity('${ci}-${iidx}', 1)">+</button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }).join('');
  container.innerHTML = html;
}
function renderDrinkSelect(ci,iidx,selected){
  // é£²æ–™é¸å–®å›ºå®šç”¨ menu.html å¯«å…¥çš„é£²å“ï¼Œä¸å†è‡ªå¸¶é¸å–®
  const drinkOptions = (menuData.find(cat=>cat.category.includes("é£²å“"))?.items || []).map(d=>d.name);
  let opts = drinkOptions.map(d => `<option value="${d}"${selected===d?' selected':''}>${d}</option>`).join('');
  return `<select onchange="selectDrink('${ci}-${iidx}',this.value)">
    <option value="">--é£²æ–™--</option>${opts}
  </select>`;
}
function selectDrink(key, val){
  const [ci,iidx] = key.split('-').map(x=>parseInt(x,10));
  menuData[ci].items[iidx].drink = val;
}
function toggleCat(key) {
  collapsedCat[key] = !collapsedCat[key];
  displayMenu();
}
function updateQuantity(key, change) {
  if (!cart[key]) cart[key] = 0;
  cart[key] += change;
  if (cart[key] <= 0) delete cart[key];
  updateCartDisplay();
  displayMenu();
}
function updateCartDisplay() {
  let totalItems = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
  let totalPrice = 0;
  Object.entries(cart).forEach(([key, qty]) => {
    const [ci,iidx] = key.split('-').map(x=>parseInt(x,10));
    const item = menuData[ci]?.items?.[iidx];
    if(item) totalPrice += (item.price || 0) * qty;
  });
  document.getElementById('cartCount').textContent = totalItems;
  document.getElementById('cartTotal').textContent = totalPrice;
  document.getElementById('checkoutBtn').disabled = totalItems === 0;
}
// === ğŸŸ¢ çµå¸³æµç¨‹ ===
function showCheckout() {
    document.getElementById('checkoutModal').style.display = 'block';
    let summaryArr = Object.entries(cart).map(([key, qty]) => {
        const [ci,iidx] = key.split('-').map(x=>parseInt(x,10));
        const item = menuData[ci]?.items?.[iidx];
        if(!item) return '';
        let str = item.name;
        if(typeof item.drink !== "undefined" && item.drink) str += `ï¼ˆ${item.drink}ï¼‰`;
        return str + ` Ã—${qty} = $${item.price*qty}`;
    });
    document.getElementById('orderSummary').innerHTML = summaryArr.map(s=>`<div>${s}</div>`).join('');
    let total = Object.entries(cart).reduce((sum, [key, qty]) => {
        const [ci,iidx] = key.split('-').map(x=>parseInt(x,10));
        const item = menuData[ci]?.items?.[iidx];
        return sum + (item ? item.price*qty : 0);
    }, 0);
    document.getElementById('orderSumTotal').textContent = total;
    document.getElementById('orderError').style.display = "none";
}
function closeCheckout() {
    document.getElementById('checkoutModal').style.display = 'none';
}
document.getElementById('orderForm').addEventListener('submit', function(e){
    e.preventDefault();
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    const note = document.getElementById('customerNote').value.trim();
    if(!name || !phone){
        document.getElementById('orderError').textContent = "è«‹è¼¸å…¥å§“åå’Œé›»è©±";
        document.getElementById('orderError').style.display = "";
        return;
    }
    let orderItems = Object.entries(cart).map(([key, qty]) => {
        const [ci,iidx] = key.split('-').map(x=>parseInt(x,10));
        const item = menuData[ci]?.items?.[iidx];
        if(!item) return null;
        return {
            name: item.name,
            price: item.price,
            drink: (typeof item.drink !== "undefined") ? item.drink : undefined,
            quantity: qty
        }
    }).filter(Boolean);
    let total = orderItems.reduce((sum, i) => sum + i.price*i.quantity, 0);
    let allOrders = [];
    try { allOrders = JSON.parse(localStorage.getItem('dandan_orders')||'[]'); } catch(e){}
    allOrders.push({
        order_number: 'D' + Date.now(),
        customer_name: name,
        customer_phone: phone,
        note: note,
        items: orderItems,
        created_at: new Date().toISOString(),
        total
    });
    localStorage.setItem('dandan_orders', JSON.stringify(allOrders));
    cart = {};
    updateCartDisplay();
    closeCheckout();
    document.getElementById('orderSuccessModal').style.display = 'block';
});
function closeSuccess(){
    document.getElementById('orderSuccessModal').style.display = 'none';
}
</script>
</body>
</html>
